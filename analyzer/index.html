<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CUCM calls analyzer</title>
<style>
	body {
		font-family: "Helvetica Neue", Helvetica, Arial;
		font-size: 14px;
		line-height: 20px;
		font-weight: 400;
		margin: 0;
		padding: 0;
		-webkit-font-smoothing: antialiased;
		font-smoothing: antialiased;
	}
	div {width: 100%;}
	div.header {
		position: fixed;
		top: 0;
		padding: 15px 0;
		z-index: 1;
		background-color: white;
		border-bottom: 1px groove black;
		text-align: center;
	}
	div.spinner {
		padding: 450px 0 0;
		text-align: center;
		display: block;
	}
	div.spinner.hidden {display: none;}
	div.content {
		padding: 80px 0px 25px;
		text-align: center;
	}
	input, select, button {
		padding: 5px 10px;
		margin: 0 7px;
		border: 1px solid black;
	}
	button:hover {background-color: #d0e0ff;}
	table, th, td {border: 1px solid darkgrey;}
	table {
		margin: 0 auto;
		border-collapse: collapse;
	}
	thead {text-align: center;}
	tbody {text-align: right;}
	th, td {padding: 5px 10px;}
	th {
		background-color: #d0e0ff;
		font-weight: 600;
	}
	tr {background-color: #f6f6f6;}
	tr:hover {background-color: #e9e9ff;}
	tr:nth-child(even) {background-color: #e9e9e9;}
	tr:nth-child(even):hover {background-color: #e3e3ff;}
</style>
</head>
<body>
	<div class="header">
		<select id="direction">
			<option value="from" selected>From</option>
			<option value="to">To</option>
			<option value="both">Both</option>
		</select>
		<input type="text" id="number" placeholder="Phone number" />
		<vr />
		<label>Data from<input type="datetime-local" id="begintime" /></label>
		<label>till<input type="datetime-local" id="endtime" /></label>
		<label><input type="checkbox" id="zero" unchecked />Show zero-duration calls</label>
		<button onclick="queryData()">Search</button>
	</div>
	<div class="spinner hidden" id="spinner">
		<img src="img/spinner.gif" alt="Loading..." />
	</div>
	<div class="content" id="content" />
	<script>
		/*
		Created by Alexandr Vezhlev.
		
		This script sets the default values of date-time input fields.
		Begin date field is set to the day-before-yesterday midnight.
		End date is set to current time with seconds reset to zero.
		*/
		var currentDate,
		twoDaysAgo,
		currentDateString,
		twoDaysAgoString;
		
		currentDate = new Date();
		twoDaysAgo = new Date(currentDate.getTime() - 1000 * 60 * 60 * 24 * 2);
		
		//some dirty dirty tricks here,
		//reset the seconds to zero, shift the time forward by timezone offset
		currentDate.setHours(currentDate.getHours() - currentDate.getTimezoneOffset() / 60, currentDate.getMinutes(), 0);
		//so that after converting the time into UTC time string we get our local time string
		currentDateString = currentDate.toISOString();
		//remove last 5 characters which are ".mscZ"
		currentDateString = currentDateString.substr(0, currentDateString.length - 5);
		
		//same here,
		//timezone shift trick while setting time to midnight
		twoDaysAgo.setHours(-twoDaysAgo.getTimezoneOffset() / 60, 0, 0);
		twoDaysAgoString = twoDaysAgo.toISOString();
		twoDaysAgoString = twoDaysAgoString.substr(0, twoDaysAgoString.length - 5);
		
		//set default date-time values to respective fields
		document.getElementById("begintime").defaultValue = twoDaysAgoString;
		document.getElementById("endtime").defaultValue = currentDateString;
		
		
		/*
		Created by Alexandr Vezhlev.
		
		This function sends AJAX request to the server-side script
		and updates interface after receiving an answer.
		*/
		function queryData() {
			
			document.getElementById("content").innerHTML = "";
			document.getElementById("spinner").className = "spinner";
			
			request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (request.readyState == 4 && request.status == 200) {
				
					showData(request.responseText);
				}
			};
			request.timeout = 10000;
			
			var beginTime = Math.floor(new Date(document.getElementById("begintime").value).getTime() / 1000) + currentDate.getTimezoneOffset() * 60;
			var endTime = Math.floor(new Date(document.getElementById("endtime").value).getTime() / 1000) + currentDate.getTimezoneOffset() * 60;
			
			request.open("GET", "getdata.php?direction=" + document.getElementById("direction").value + 
											"&number=" + document.getElementById("number").value + 
											"&begintime=" + beginTime + 
											"&endtime=" + endTime + 
											"&zero=" + document.getElementById("zero").checked
											, true);
			request.send();
		}
		
		
		function showData(data) {
			
			var calls = JSON.parse(data);
			var columnCount = calls[0].length;
			
			var table = document.createElement("TABLE");
			var thead = document.createElement("THEAD");
			table.appendChild(thead);
 
			var row = thead.insertRow(-1);
			
			for (var i = -1; i < columnCount; i++) {
				var headerCell = document.createElement("TH");
				headerCell.innerHTML = i < 0 ? "#" : calls[0][i];
				row.appendChild(headerCell);
			}
			
			var tbody = document.createElement("TBODY");
			table.appendChild(tbody);
			
			var totalDuration = 0;
 
			for (var i = 1; i < calls.length; i++) {
				row = tbody.insertRow(-1);
				for (var j = -1; j < columnCount; j++) {
					var cell = row.insertCell(-1);
					switch (j) {
						case -1:
							cell.innerHTML = i;
							break;
						case 6:
							totalDuration += parseInt(calls[i][j]);
							cell.innerHTML = getDurationString(calls[i][j]);
							break;
						default:
							cell.innerHTML = calls[i][j];
					}
				}
			}
			
			row = tbody.insertRow(-1);
			var cell = row.insertCell(-1);
			cell.colSpan = columnCount;
			cell.innerHTML = "Total duration";
			row.insertCell(-1).innerHTML = getDurationString(totalDuration);
			
			document.getElementById("spinner").className = "spinner hidden";
			document.getElementById("content").appendChild(table);
		}
		
		
		function getDurationString(duration) {
		
			var h = Math.floor(duration / 3600);
			var m = Math.floor((duration - h *3600) / 60);
			var s = duration - h *3600 - m * 60;
		
			return (h > 0 ? h + ":" : "") + pad(m) + ":" + pad(s);
		
		}
		
		
		function pad(num) {
			
			return num < 10 ? "0" + num : num;
		}
	</script>
</body>
</html>
